!function(i){EmailTemplatesAdmin={init(){i(document).on("click","#wcf_preview_email",EmailTemplatesAdmin.send_test_email),i(document).on("click",".wcf-ca-switch.wcf-toggle-template-status",EmailTemplatesAdmin.toggle_activate_template),i(document).on("click","#wcf_ca_delete_coupons",EmailTemplatesAdmin.delete_coupons),i(document).on("click","#wcf_ca_export_orders",EmailTemplatesAdmin.export_orders),i(document).on("click","#wcf-export-templates",EmailTemplatesAdmin.export_templates),i(document).on("click",".wcf-export-template",EmailTemplatesAdmin.export_templates),i(document).on("click","#doaction, #doaction2",EmailTemplatesAdmin.handle_bulk_action),i(document).on("click","#wcf-import-templates",EmailTemplatesAdmin.open_import_modal),i(document).on("click",".wcf-ca-modal-close, .wcf-ca-action--cancel",EmailTemplatesAdmin.close_import_modal),i(document).on("submit","#wcf-ca-import-form",EmailTemplatesAdmin.import_templates),i(document).on("change","#wcf-ca-import-file",EmailTemplatesAdmin.handle_file_change),i(document).on("dragover","#wcf-import-modal",EmailTemplatesAdmin.prevent_default),i(document).on("drop","#wcf-import-modal",EmailTemplatesAdmin.handle_file_drop),i(document).on("click",".wcf-ca-remove-file",EmailTemplatesAdmin.reset_import_file),i(document).on("click",".wcar-switch-grid",EmailTemplatesAdmin.toggle_activate_template_on_grid);const e="#wcf_email_discount_type, #wcf_email_discount_amount, #wcf_email_coupon_expiry_date, #wcf_free_shipping_coupon, #wcf_auto_coupon_apply, #wcf_individual_use_only";i(e).closest("tr").toggle(i("#wcf_override_global_coupon").is(":checked")),i(document).on("click","#wcf_override_global_coupon",function(){i(e).closest("tr").fadeToggle(i("#wcf_override_global_coupon").is(":checked"))})},send_test_email(){let e="";e=jQuery("#wp-wcf_email_body-wrap").hasClass("tmce-active")?tinyMCE.get("wcf_email_body").getContent():jQuery("#wcf_email_body").val();var t=i("#wcf_email_subject").val(),a=i("#wcf_send_test_email").val(),o=document.getElementsByName("id")[0].value,c=i("#_wpnonce").val();i(this).next("div.error").remove(),i.trim(e)?i.trim(t)?i.trim(a)?(c={email_subject:t,email_body:e,email_send_to:a,email_template_id:o,action:"wcf_ca_preview_email_send",security:c},i("#wcf_preview_email").css("cursor","wait").attr("disabled",!0),i.post(ajaxurl,c,function(e){i("#mail_response_msg").empty().fadeIn(),e.success?i("#mail_response_msg").css("color","green").html("<strong> Email has been sent successfully! </strong>").delay(3e3).fadeOut():i("#mail_response_msg").css("color","red").html("<strong> Email sending failed! Please check your SMTP settings!  </a></strong>").delay(3e3).fadeOut(),i("#wcf_preview_email").css("cursor","").attr("disabled",!1)})):i(this).after('<div class="error-message wcf-ca-error-msg"> You must add your email id! </div>'):i(this).after('<div class="error-message wcf-ca-error-msg"> Email subject is required! </div>'):i(this).after('<div class="error-message wcf-ca-error-msg"> Email body is required! </div>'),i(".wcf-ca-error-msg").delay(2e3).fadeOut()},delete_coupons(){var e;confirm(wcf_ca_localized_vars._confirm_msg)&&(e={action:"wcf_ca_delete_garbage_coupons",security:wcf_ca_localized_vars._delete_coupon_nonce},i(".wcf-ca-spinner").show(),i(".wcf-ca-spinner").addClass("is-active"),i("#wcf_ca_delete_coupons").css("cursor","wait").attr("disabled",!0),i.post(ajaxurl,e,function(e){i(".wcf-ca-response-msg").empty().fadeIn(),e.success&&(i(".wcf-ca-spinner").hide(),i(".wcf-ca-response-msg").css("color","green").html(e.data).delay(5e3).fadeOut()),i("#wcf_ca_delete_coupons").css("cursor","").attr("disabled",!1)}))},export_orders(){confirm(wcf_ca_localized_vars._confirm_msg_export)&&(window.location.href=window.location.search+"&export_data=true&security="+wcf_ca_localized_vars._export_orders_nonce)},export_templates(e,t){e&&e.preventDefault();const a=i(e?e.currentTarget:"#wcf-export-templates");var o=a.data("nonce"),e=a.data("id");const c={action:"wcf_ca_export_email_templates",_wpnonce:o};Array.isArray(t)&&t.length?c.ids=t:void 0!==e&&(c.ids=[e]),i.ajax({url:ajaxurl,method:"POST",dataType:"json",data:c,beforeSend(){"wcf-export-templates"===a.attr("id")&&(a.prop("disabled",!0).text("Exporting..."),i("#wcf-export-spinner").addClass("is-active").show())}}).done(function(e){e=new Blob([JSON.stringify(e)],{type:"application/json"}),e=window.URL.createObjectURL(e);const t=document.createElement("a");t.href=e,t.download="cart_abandonment_email_templates.json",document.body.appendChild(t),t.click(),window.URL.revokeObjectURL(e),t.remove()}).always(function(){"wcf-export-templates"===a.attr("id")&&(a.prop("disabled",!1).text("Export"),i("#wcf-export-spinner").removeClass("is-active").hide())})},handle_bulk_action(e){const t=i(e.currentTarget);var a="doaction"===t.attr("id")?"#bulk-action-selector-top":"#bulk-action-selector-bottom";"export_email_templates"===i(a).val()&&(e.preventDefault(),(e=i('input[name="id[]"]:checked').map(function(){return i(this).val()}).get()).length&&EmailTemplatesAdmin.export_templates(null,e))},toggle_activate_template_on_grid(){const t=i(this),e=t.attr("wcf-ca-template-switch"),a="on"===e?"green":"red";i.post(ajaxurl,{action:"activate_email_templates",id:i(this).attr("id"),state:e,security:wcf_ca_details.email_toggle_button_nonce},function(e){i("#wcf_activate_email_template").val(0),i(".wcar_tmpl_response_msg").remove(),i("<span class='wcar_tmpl_response_msg'> "+e.data+" </span>").insertAfter(t).delay(2e3).fadeOut().css("color",a)})},toggle_activate_template(){const e=i(this),t=e.attr("wcf-ca-template-switch");var a="on"===t?"off":"on";i("#wcf_activate_email_template").val("on"==a?1:0),e.attr("wcf-ca-template-switch",a)},open_import_modal(){i("#wcf-import-modal").show()},close_import_modal(){i("#wcf-import-modal").hide()},import_templates(e){e.preventDefault();e=document.getElementById("wcf-ca-import-file");if(e.files.length){const t=new FileReader;t.onload=function(e){let t=e.target.result;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return}i.ajax({url:ajaxurl,type:"POST",data:{action:"wcf_ca_import_email_templates",_wpnonce:i('#wcf-ca-import-form [name="_wpnonce"]').val(),templates:JSON.stringify(t)},beforeSend:EmailTemplatesAdmin.show_import_loader}).done(function(){window.location.reload()})},t.readAsText(e.files[0])}},handle_file_change(){var e=this.files[0];e?(i(".wcf-ca-file-name").text(e.name),i(".wcf-ca-file-preview").show()):EmailTemplatesAdmin.reset_import_file()},handle_file_drop(e){EmailTemplatesAdmin.prevent_default(e);e=e.originalEvent.dataTransfer.files;if(e&&e.length){const t=document.getElementById("wcf-ca-import-file");t.files=e,EmailTemplatesAdmin.handle_file_change.call(t)}},prevent_default(e){e.preventDefault(),e.stopPropagation()},reset_import_file(){i("#wcf-ca-import-file").val(""),i(".wcf-ca-file-preview").hide()},show_import_loader(){i("#wcf-ca-import-form .spinner").addClass("is-active").show(),i('#wcf-ca-import-form button[type="submit"]').prop("disabled",!0)}},i(function(){EmailTemplatesAdmin.init()})}(jQuery);